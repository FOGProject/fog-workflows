name: Hello World POCs

on:
  workflow_dispatch:
jobs:
  demo_app_authentication:
    runs-on: ubuntu-latest
    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.FOG_WORKFLOWS_APPID }}
          private-key: ${{ secrets.FOG_WORKFLOWS_PRIVATE_KEY }}

      - name: Use the token
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh api octocat

  get-release-version:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          # required
          app-id: ${{ vars.FOG_WORKFLOWS_APPID }}
          private-key: ${{ secrets.FOG_WORKFLOWS_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: FOGProject/fogproject
          ref: dev-branch
          # Make sure the value of GITHUB_TOKEN will not be persisted in repo's config
          persist-credentials: false
      
      - name: Get version to be released and create PR with that in the name
        run: | 
          echo 'Get version to be released and create PR with that in the name'
          system_file="$(git rev-parse --show-toplevel)/packages/web/lib/fog/system.class.php"
          tag=$(grep "define('FOG_VERSION'" $system_file | sed "s/.*FOG_VERSION', '\([^']*\)');/\1/")
          echo "Tag: $tag"
          gh pr create -R FOGProject/fogproject -B stable -H dev-branch --title "Stable Release PR For ${tag} - $(date '+%Y-%m-%d')" --body "Pull Request for creating the latest stable release from staged security fixes, bug fixes, and minor enhancements in dev-branch. Created as needed or monthly on 15th of every month, released once tests are passing"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}